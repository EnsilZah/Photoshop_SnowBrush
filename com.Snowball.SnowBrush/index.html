<!doctype html>

<script src="./js/JSX.js"></script>
<script src="./lib/CSInterface.js"></script>
<script src="./jQueryAssets/jquery-1.8.3.min.js"></script>

<script>	
 	var fs = require('fs-extra');
 	var zipper = require("zip-local");
	var path = require('path');

	path.joinU = function(){	return path.join.apply({}, arguments).replace(/\\/g, '/');	}
	path.normalizeU = function() {return path.normalize.apply({}, arguments).replace(/\\/g, '/');	}

	var csInterface = new CSInterface();
	loadJSX("SnowBrush.jsx")
</script>

<link id="ppstyle" rel="stylesheet" type="text/css" href="./css/style.css">

<html>
	<body id="mainBody" onresize="NBPanel.event.resizeDoc()" onLoad="onLoadedDoc();" style="overflow: hidden; padding:0px; margin:0px; height:100%" ondrop='NBPanel.import.dropped(event)'>


	<span id="Modal_Settings_Container" style="margin: 0 0 0 0;"></span>
	<script>$("#Modal_Settings_Container").load("HTML/Modals/Modal_Settings.html");</script>

	<span id="Modal_About_Container" style="margin: 0 0 0 0;"></span>
	<script>$("#Modal_About_Container").load("HTML/Modals/Modal_About.html");</script>

	<span id="Modal_Loading_Container" style="margin: 0 0 0 0;"></span>
	<script>$("#Modal_Loading_Container").load("HTML/Modals/Modal_Loading.html");</script>

	<div style="padding:0;margin:0">

		<div id="ToolBar" class="inputBar" oncontextmenu="contextDefault()" align="left" style="height:inherit;"  >
			<button class="toolButton" onclick="NBPanel.tool.brush.set()">			<img src='images/ToolBrush.png'  alt='' align='center' style='margin:0'>			</button>
			<button class="toolButton">			<img src='images/ToolPencil.png' onclick="NBPanel.tool.pencil.set()" alt='' align='center' style='margin:0'>			</button>
			<button class="toolButton">			<img src='images/ToolMixBrush.png' onclick="NBPanel.tool.mixbrush.set()" alt='' align='center' style='margin:0'>		</button>
			<button class="toolButton">			<img src='images/ToolErase.png' onclick="NBPanel.tool.erase.set()" alt='' align='center' style='margin:0'>				</button>
			<button class="toolButton">			<img src='images/ToolSharpen.png' onclick="NBPanel.tool.sharpen.set()" alt='' align='center' style='margin:0'>			</button>
			<button class="toolButton">			<img src='images/ToolBlur.png' onclick="NBPanel.tool.blur.set()" alt='' align='center' style='margin:0'>				</button>
			<button class="toolButton">			<img src='images/ToolSmudge.png' onclick="NBPanel.tool.smudge.set()" alt='' align='center' style='margin:0'>			</button>
			<button class="toolButton">			<img src='images/ToolDodge.png'onclick="NBPanel.tool.dodge.set()" alt='' align='center' style='margin:0'>				</button>
			<button class="toolButton">			<img src='images/ToolBurn.png'onclick="NBPanel.tool.burn.set()" alt='' align='center' style='margin:0'>					</button>
			<button class="toolButton">			<img src='images/ToolSponge.png'onclick="NBPanel.tool.sponge.set()" alt='' align='center' style='margin:0'>				</button>
			<button class="toolButton">			<img src='images/toolStamp.png'onclick="NBPanel.tool.stamp.set()" alt='' align='center' style='margin:0'>				</button>
		</div>
			

		<div id="RecentBar" class="inputBar"  oncontextmenu="contextDefault()" align = "left"  ></div>


		<div id="SearchBar" class="inputBar" oncontextmenu="contextDefault()" align = "left" style="" >
			<table width="100%" style="position: relative;top:-2px">
				<td  align='left' >
					<img src='images/search.png' alt='' align='center' style="padding:0 1px 0 3px" >
				</td>

				<td width="100%">
					<input id="searchText" type="text" align='center' onkeydown="keydownSelectAll(event)" onkeyup="NBPanel.search.update(event);" class="textStrip" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" style="width:inherit;">
				</td>

				<td align='right' style='white-space: nowrap;'>		
					<button class="toolButton" align="right" onclick="NBPanel.search.clear()" style="border-radius:6px;  width:18px;height:18px;position: relative; top:0px">X</button>
					<button class="toolButton" id="searchToggleAll" align="right" onclick="NBPanel.search.setAll(!NBPanel.search.searchAll)" style="width:35px;height:18px;position: relative; top:0px">All</button>		
				</td>
			</table>
		</div>


		<div id="TopBar" class="inputBar" oncontextmenu="contextDefault()" align="left" style="position:relative;bottom:-1px; height:inherit;overflow:visible;background-image:URL(./images/elements/tabdivider.png);">
			<button id='btn_AddEntry' style="border-color:#303030" onclick="NBPanel.tabs.appendTab('Untitled');" class="TabButton" >+</button>	
			<button id='btn_Shared' oncontextmenu="event.stopPropagation(); contextSharedTab()" class="TabButton TabShared" style="border-color:#303030;position:relative;top:-2px;"  >Shared </button>	
		</div>


		<div id="ContainerBar" oncontextmenu="contextDefault()" align = "left" style="position:fixed;width:100%;height:calc(100%);overflow:visible;background-color:#444444;px;margin:0;align:left">

			<div id="sharedTabBrushGroup" class="scroll"></div>
		</div>


		<div id="bottomBar" class="footer" oncontextmenu="contextDefault()" >
			<div class = "inputBar noedge" style="height:17px">
				<table width="100%" class="noedge" style="position: relative;overflow:hidden;">
					
					<td align='left' style="width:1%; white-space:nowrap;" >
						<button onclick ="modalSettings.open()"  class="toolButton " style="position:relative; top:-5px;height:15px;">
						<img src='images/buttons/settings.png' alt=''  style="opacity:.5"/>
						</button>

						<button id='btn_AddTool' onclick="NBPanel.import.currentTool()" class="toolButton" title="Add current" style="position:relative; margin-left:5px; top:-5px; height:15px; " >
							<img src='images/buttons/AddBrush.png' alt='' style="opacity:.5"/>
						</button>

						<button id='btn_AddFromFile' onclick="NBPanel.import.file()" class="toolButton" title="Import File" style="position:relative; top:-5px; height:15px;" >
							<img src='images/buttons/AddFile.png' alt=''  style="opacity:.5"/>
						</button>
					</td>

					<td >
						 <input class="slider" type="range" id="sizeSlider" value="64" min ="16" max = "64" style ="width:100%; position:relative;top:-4px" oninput = "NBPanel.event.sliderChanging()" onchange="NBPanel.event.sliderChanged()">
					</td >


					<td align='right'  style="width:1%; white-space:nowrap;">		
						<button id='toggleShortThumb' onclick="NBPanel.settings.setThumbShort(!NBPanel.settings.values.showShortThumb)" class="toolButton" title="Show short thumbnail" style="position:relative;top:-8px;height:15px;" >
							<img src='images/Buttons/Button_ShortThumb.png' alt='' style="opacity:0.8;vertical-align:middle;"/>
						</button>


						<button id='toggleLongThumb' onclick="NBPanel.settings.setThumbLong(!NBPanel.settings.values.showLongThumb)" class="toolButton" title="Show long thumbnail" style=" position:relative; top:-8px;height:15px;" >
							<img src='images/buttons/Button_LongThumb.png' alt='' style="opacity:0.8;vertical-align:middle;"/>
						</button>

						<button id='toggleTxt' onclick="NBPanel.settings.setTxt(!NBPanel.settings.values.showText)" class="toolButton" title="Show brush name" style="position:relative;top:-8px; height:15px;" >
							<img src='images/buttons/Button_TXT.png' alt='' style="opacity:0.8;vertical-align:middle;"/>
						</button>

						<button id='toggleColor' onclick="NBPanel.settings.setColor(!NBPanel.settings.values.useColor)" class="toolButton" title="Use color" style="position:relative; margin:0px; top:-8px; height:15px;" >
							<img src='images/buttons/Button_ColorChange.png' alt='' style="opacity:0.8; vertical-align:middle;"/>
						</button>
					</td>

					<td style="width:10px">
						
					</td>

				</table>
			</div>
		</div>


	</div>


	</body>
</html>

<script> //HTML related stuff


window.addEventListener("dragover",function(e){e = e || event; e.preventDefault();},false);
window.addEventListener("drop",function(e){e = e || event; e.preventDefault();},false);

//Prevent drag-select
document.onselectstart = function(e)
{
    if(e.stopPropagation) e.stopPropagation();
    if(e.preventDefault) e.preventDefault();
    e.cancelBubble=true;
    e.returnValue=false;
    return false;
};	



function allowDrop(ev)
{
	ev.preventDefault();
}

function removeElement(inElement)
{
	inElement.parentElement.removeChild(inElement)
}










//Main code

var NBPanel = null;

function onLoadedDoc()
{
	NBPanel = new SnowBrushPanel();

	NBPanel.initialize();
}





appendEntryIDs = function(retVal)
{
	var curTab = NBPanel.tabs.tabList[NBPanel.tabs.activeTab]

	for (var i = 0; i < retVal.length; i++)
	{	
			curTab.data.brushes.push(retVal[i])
			NBPanel.tabs.tabCurrent().appendBrush(retVal[i])
	}

	NBPanel.tabs.tabCurrent().writeFile()		
	NBPanel.brushes.updateLook()
	Modal_Loading.close()
}


function SnowBrushPanel()
{

	this.brushButton =
	{
		ShortThumbSize: {width:64, height:64},
		LongThumbSize: {width:256, height:64},
		Margin: {width:2, height:64},
		DefaultColor: {red:48, green:48, blue:48},
		DefaultColorH: "#303030",

	}

	this.event = 
	{
		sliderChanged:function()
		{
			NBPanel.settings.values.scaleSlider = document.getElementById("sizeSlider").value;
			NBPanel.settings.write()		
		},

		sliderChanging:function()
		{
			NBPanel.brushes.updateLook()
		},

		updateBrush:function(inSliderValue)
		{
			var scale = inSliderValue / NBPanel.brushButton.ShortThumbSize.height;
			var ShortThumb = NBPanel.brushButton.ShortThumbSize
			var LongThumb = NBPanel.brushButton.LongThumbSize
			var Margin = NBPanel.brushButton.Margin

			var showLong = NBPanel.settings.values.showLongThumb
			var showShort = NBPanel.settings.values.showShortThumb
			var showText = NBPanel.settings.values.showText

			var ThumbButton = this.button.childNodes[0];
			var TextButton = this.button.childNodes[1];
			
			TextButton.childNodes[1].style.width = TextButton.clientWidth - 40 + "px"	
			TextButton.style.width = scale * (showShort * ShortThumb.width +  Margin.width + showLong * LongThumb.width) + "px";
			TextButton.style.display = showText ? "block" : "none"
	
			ThumbButton.style.height = scale * ShortThumb.height + "px";
			ThumbButton.style.width = scale * (showShort*ShortThumb.width +  Margin.width + showLong * LongThumb.width) + "px";
			ThumbButton.style.backgroundSize = scale *showShort*ShortThumb.width + "px "+ scale * showShort *ShortThumb.height+"px," + showLong*LongThumb.width * scale + "px, " + showLong*LongThumb.height + "px";


			var BG = TextButton.childNodes[0].childNodes[1].style
			var FG = TextButton.childNodes[0].childNodes[0].style

			if (NBPanel.settings.values.useColor)
			{
				var brushData = this.data

				if (brushData.colorBG == undefined)
				brushData.colorBG = NBPanel.brushButton.DefaultColor;
				if (brushData.colorFG == undefined)
				brushData.colorFG = NBPanel.brushButton.DefaultColor;

				BG.backgroundColor = "rgb("+ Math.floor(brushData.colorBG.red) + "," + Math.floor(brushData.colorBG.green) + "," + Math.floor(brushData.colorBG.blue) +")"
				FG.backgroundColor = "rgb("+ Math.floor(brushData.colorFG.red) + "," + Math.floor(brushData.colorFG.green) + "," + Math.floor(brushData.colorFG.blue) +")"		
			}
			else
			{
				BG.backgroundColor = NBPanel.brushButton.DefaultColorH;
				FG.backgroundColor = NBPanel.brushButton.DefaultColorH;		
			}		
		},

		resizeDoc:function()
		{
			var containerBar = document.getElementById("ContainerBar")

			var nodes = Array.prototype.slice.call( containerBar.parentElement.children );

			var curElement = nodes.indexOf( containerBar );
			var heightOffest = 0
			for (var i = 0; i < nodes.indexOf( containerBar ); i++)
			{
				heightOffest += containerBar.parentElement.children[i].offsetHeight
			}

			//Make sure ContainerBar fills the same area as tab bar pushes it down.
			containerBar.style.top=heightOffest+"px"
			containerBar.style.height = document.body.scrollHeight + 24 - heightOffest + "px"
		},
	}


	this.path =
	{
		data: 		path.joinU(csInterface.getSystemPath(SystemPath.MY_DOCUMENTS), "SnowBrush" ),
		tabs: 		path.joinU(csInterface.getSystemPath(SystemPath.MY_DOCUMENTS), "SnowBrush", "Tabs" ),
		entries: 	path.joinU(csInterface.getSystemPath(SystemPath.MY_DOCUMENTS), "SnowBrush", "Entries" ),
		temp: 		path.joinU(csInterface.getSystemPath(SystemPath.MY_DOCUMENTS), "SnowBrush", "Temp" )
	}

	this.import =
	{
		dropped: function(event)
		{
			event.dataTransfer.items[0].getAsString(function(s)
			{
				data = JSON.parse(s);

				if (data.assetList[0].type == "brush")
				{
					Modal_Loading.open("Processing...")
					brushID = data.assetList[0].data[0]
					brushName = data.assetList[0].name

					var dataJSX = {pathEntries:NBPanel.path.entries, pathTemp:NBPanel.path.temp, brushID:brushID, brushName:brushName}
					JSONtoJSX("createEntryFromExisting", dataJSX, appendEntryIDs)
				}
			})
		},

		currentTool: function()
		{
			Modal_Loading.open("Processing...")

			//TODO: Need to ensure we are using correct tool type.
			var dataJSX = {pathEntries:NBPanel.path.entries, pathTemp:NBPanel.path.temp}
			JSONtoJSX("createEntryFromExisting", dataJSX, appendEntryIDs)			
		},

		file:function()// AddFromFile()
		{
			var curFile = window.cep.fs.showOpenDialogEx(false,false,"Brush File:", "%USERPROFILE%/Desktop",["abr","tpl","zip"], "Brush Files").data;
			if (curFile == "") return;
			curFile = curFile[0];

			Modal_Loading.open("Processing...")

			var dataJSX = {pathSource:curFile, pathEntries:NBPanel.path.entries, pathTemp:NBPanel.path.temp}

			var curExtension = path.parse(curFile).ext.toLowerCase()
			switch(curExtension)
			{
				case ".abr":
					command = 
					JSONtoJSX("entriesFromABR", dataJSX, appendEntryIDs)
					break;
				case ".tpl":
					JSONtoJSX("entriesFromTPL", dataJSX, appendEntryIDs)
					break;
				case ".zip":
					this.zip(curFile);
					break;
				default:
					alert("Error importing file!")
					break;
			}	
		},

		zip: function(inPath)
		{
			var tmpFolder = path.joinU(NBPanel.path.data, "temp/unzip")
			fs.emptyDirSync(tmpFolder);

			zipper.sync.unzip(inPath).save(tmpFolder)

			try
			{
				var pathManifest = path.joinU(tmpFolder, "NB_Manifest.json")
				curManifest = fs.readJsonSync(pathManifest)
			}
			catch(e)
			{
				fs.emptyDirSync(tmpFolder);
				return;
			}

			switch(curManifest.type)
			{
				case "SINGLEBRUSH":
					NBPanel.import.entry(tmpFolder)
					break;

				case "SINGLETAB":
					NBPanel.import.tab(tmpFolder)
					break;

				default:
					alert("Manifest Error");
			}
		},

		entry: function(inPath_Temp)
		{
			Modal_Loading.open("Processing...")

			var newEntryID = getEntryInc(NBPanel.path.entries)

			var pathSource = path.joinU (inPath_Temp,"Entries/00000000")
			var pathDest = path.joinU(NBPanel.path.entries, newEntryID)
			
			fs.mkdirSync(pathDest);
			fs.copySync(pathSource, pathDest)
			fs.emptyDirSync( path.joinU (NBPanel.path.temp, "unzip") );		

			appendEntryIDs([newEntryID])
		},

		tab:function(inPath_Temp)
		{
			Modal_Loading.open("Processing...")

			var pathSource = path.joinU(inPath_Temp, "Entries")
			var curEntries = fs.readdirSync(pathSource)

		    var newIDs = []
		    for (var i = 0; i < curEntries.length; i++)
		    {
		        var newEntryID = getEntryInc(NBPanel.path.entries)
		        newIDs.push(newEntryID)

		        var pathEntrySource = path.joinU(inPath_Temp, "Entries", curEntries[i]);
		        var pathEntryDest =  path.joinU(NBPanel.path.entries, newEntryID)
		    	fs.copySync(pathEntrySource, pathEntryDest)
		    }

		    var pathTab = path.joinU(inPath_Temp, "/Tabs/00000000")
		    var tabName = fs.readJsonSync(pathTab).name
			NBPanel.tabs.appendTab(tabName, false)

			appendEntryIDs(newIDs)
		},

	}


	this.export =
	{
		brush:function(inBrushID) // Exports a single brush
		{
			var currentFile = window.cep.fs.showOpenDialogEx(false, true,"Export Location:", null,null, "EXPORT HERE").data;
			if (currentFile == "" ) {return;}
			currentFile = currentFile[0]

			Modal_Loading.open("Processing...")

			var tmpFolder = path.joinU(NBPanel.path.temp,"zip")
			fs.emptyDirSync(tmpFolder);
			
		    var manifestFile = path.joinU(tmpFolder,"/NB_Manifest.json")
		    var manifestData = {name:"NB_Manifest", version:"0002", type:"SINGLEBRUSH"}
			fs.outputJsonSync(manifestFile, manifestData)

		    var pathTempEntries = path.joinU(tmpFolder,"Entries")
			fs.mkdirSync(pathTempEntries);

			var newEntryID = getEntryInc(pathTempEntries)
			var savePath = path.joinU(pathTempEntries,newEntryID)
			fs.mkdirSync(savePath);

			var entryPath = path.joinU(NBPanel.path.entries,inBrushID);
			fs.copySync(entryPath, savePath)

		 	var inBrushName = NBPanel.brushes.brush(inBrushID).tabEntry.data.name
		 	var destPath = path.joinU(currentFile,"NBBRUSH_" + inBrushName + ".zip")

			zipper.zip(tmpFolder, function(error, zipped)
			{
				if (error)
				{alert("Error compressing file.");fs.removeSync(tmpFolder); return;}

		        zipped.compress(); 		 
		        zipped.save(destPath, function(error)
		        {
		        	fs.removeSync(tmpFolder);
		        	if (error)
					{alert("Error saving file.");return;}
		    		Modal_Loading.close()
		        });
			});
		},


		tab: function(inTabID)
		{
			var currentFile = window.cep.fs.showOpenDialogEx(false, true,"Export Location:", null,null, "EXPORT HERE").data;
			if (currentFile == "" ) {Modal_Loading.close(); return;}
			currentFile = currentFile[0]

			Modal_Loading.open("Processing...")

			//Create temp zip folder
			var tmpFolder = path.joinU (NBPanel.path.temp, "zip")
			fs.emptyDirSync(tmpFolder);

			//Create manifest file
		    var manifestFile = path.joinU(tmpFolder ,"/NB_Manifest.json")
		    var manifestData = {name:"NB_Manifest", version:"0002", type:"SINGLETAB"}
		    fs.outputJsonSync(manifestFile,manifestData)

			//Copy tab data
		    var pathTempTabs = path.joinU(tmpFolder, "/Tabs")
		    fs.mkdirSync(pathTempTabs);
		    var pathTabSource = path.joinU(NBPanel.path.tabs, inTabID)
		    var pathTabDest = path.joinU(pathTempTabs, "00000000")
		    fs.copySync(pathTabSource, pathTabDest)

		    var pathTempEntries = path.joinU(tmpFolder,"Entries");
			fs.mkdirSync(pathTempEntries);


			var brushIDs = NBPanel.tabs.tab(inTabID).getBrushIDs()
			for (var i = 0; i < brushIDs.length; i++)
			{
				var newEntryID = getEntryInc(pathTempEntries);
				var savePath = path.joinU (pathTempEntries, newEntryID);
				fs.mkdirSync(savePath);		

				var entryPath = path.joinU (NBPanel.path.entries, brushIDs[i]);
				fs.copySync(entryPath, savePath)
			}

			var sourcePath = tmpFolder;
		 	var destPath = path.joinU(currentFile, "NBTAB_" + NBPanel.tabs.tab(inTabID).name + ".zip");
			zipper.zip(sourcePath, function(error, zipped)
			{
				if (error)
				{alert("Error compressing file.");fs.emptyDirSync(tmpFolder); return;}

		        zipped.compress(); 		 
		        zipped.save(destPath, function(error)
		        {
		        	fs.removeSync(tmpFolder);
		        	if (error)
					{alert("Error saving file.");return;}
		    		Modal_Loading.close()
		        });
			});

			return;
		},
	}



	//TODO: make sure recent brush button is removed when brush is removed.
	this.recentBrushes=
	{
		element: document.getElementById("RecentBar"),
		maxLength:30,
		list:[],

		save:function()
		{

		},

		load:function()
		{


		},

		add:function(inBrushPath)
		{
			inBrushPath = inBrushPath.substring(0,inBrushPath.indexOf("/Entry.abr"))

			var btn = document.createElement("BUTTON");
			btn.className = "recentBrushButton"
			btn.style.borderRadius = "0px"
			btn.value = inBrushPath
			var thumbShort = "url("+ encodeURI(path.joinU(inBrushPath,"ThumbShort.png"))+"?" + new Date().getTime()  + ")"
			btn.style.backgroundImage = thumbShort
				btn.style.backgroundSize = "22px 22px"
			btn.onclick = function(){eval(this.dataset.script)}

	
			btn.dataset.id = inBrushPath.substring(inBrushPath.length-8)


			btn.dataset.script = NBPanel.brushes.brush(btn.dataset.id).element.firstChild.dataset.script 

			this.element.insertAdjacentElement('afterbegin', btn);


			//Remove duplicates
			for (var i =  this.element.childNodes.length - 1; i > 0; i--)
			{
				if (this.element.childNodes[i].dataset &&(this.element.childNodes[i].dataset.id == btn.dataset.id))
				{
					this.element.removeChild(this.element.childNodes[i])
				}
			}

			//Remove above maxLength
			for (var i = this.element.childNodes.length - 1; i > this.maxLength; i-- )
			{
				this.element.removeChild(this.element.childNodes[i])
			}	
		},
	}

	this.search=
	{
		searchAll:true,
		brushGroup:null,
		textElement:document.getElementById("searchText"),
		searchAllElement:document.getElementById("searchToggleAll"),
		tabBody:null,

		//zzz

		clear:function()
		{
			this.textElement.value = ""
			this.update();
		},


		setAll:function(inVar)
		{

			this.searchAll = inVar
			this.searchAllElement.innerHTML  = (inVar?"All":"Tab")
			this.populate();

		},

		update:function(e)
		{
			if (this.textElement.value == "")
			{

				this.brushGroup.style.display = "none"
			}
			else
			{
				this.brushGroup.style.display = "block"
				this.populate();
			}
		},

		clearResults:function()
		{
			while (this.brushGroup.firstChild) 
			{
    			this.brushGroup.removeChild(this.brushGroup.firstChild);
			}		
		},

		populate:function()
		{
			this.clearResults();
			var searchString = this.textElement.value.toLowerCase()
			var searchRange = this.searchAll ? NBPanel.brushes.getAll() : NBPanel.brushes.getCurrent();

			var result = searchRange.filter(function(brush)
			{
				return brush.data.name.toLowerCase().indexOf(searchString) != -1
			})

			for (var i = 0; i < result.length; i++)
			{
				var copyButton = $(result[i].button).clone(true,true)[0]
				copyButton.firstChild.onclick = result[i].button.firstChild.onclick
				this.brushGroup.appendChild(copyButton);
			}			
		},

		init:function()
		{
			//create tab body
		    var brushGroupElement = document.createElement("div");
			brushGroupElement.id = "searchResultBrushGroup"
			brushGroupElement.className = "scroll"
			document.getElementById("ContainerBar").appendChild(brushGroupElement)
			this.tabBody = brushGroupElement;

			this.brushGroup = brushGroupElement;
			brushGroupElement.style.display = "none"
		},
	}



	this.tool=
	{
		blur:
		{
			id:"BlTl",
			set:function()
			{			
				csInterface.evalScript("setToolKeepPreset('"+this.id+"')");
			},	
		},

		brush:
		{
			id:"PbTl",
			set:function()
			{	
				csInterface.evalScript("setToolKeepPreset('"+this.id+"')");
			},		
		},

		burn:
		{
			id:"BrTl",
			set:function()
			{			
				csInterface.evalScript("setToolKeepPreset('"+this.id+"')");
			},				
		},
		dodge:
		{
			id:"DdTl",
			set:function()
			{			
				csInterface.evalScript("setToolKeepPreset('"+this.id+"')");
			},				
		},
		erase:
		{
			id:"ErTl",
			set:function()
			{			
				csInterface.evalScript("setToolKeepPreset('"+this.id+"')");
			},				
		},

		mixbrush:
		{
			id:"MixB",
			set:function()
			{			
				csInterface.evalScript("setToolKeepPreset('"+this.id+"')");
			},				
		},
		pencil:
		{
			id:"PcTl",
			set:function()
			{			
				csInterface.evalScript("setToolKeepPreset('"+this.id+"')");
			},				
		},
		sharpen:
		{
			id:"ShTl",
			set:function()
			{			
				csInterface.evalScript("setToolKeepPreset('"+this.id+"')");
			},				
		},
		smudge:
		{
			id:"SmTl",
			set:function()
			{			
				csInterface.evalScript("setToolKeepPreset('"+this.id+"')");
			},				
		},
		sponge:
		{
			id:"SrTl",
			set:function()			{			
				csInterface.evalScript("setToolKeepPreset('"+this.id+"')");
			},				
		},
		stamp:
		{
			id:"ClTl",
			set:function()
			{			
				csInterface.evalScript("setToolKeepPreset('"+this.id+"')");
			},				
		},
	}

	this.brushes=
	{
		activeBrush:null,

		getAll: function()
		{
			var brushList = []
			for (var i = 0; i <  NBPanel.tabs.tabList.length; i++)
			{
				brushList.push.apply(brushList, NBPanel.tabs.tabList[i].brushes);
			}	

			brushList.push.apply(brushList, NBPanel.sharedTab.brushList);
			return brushList;
		},

		getCurrent: function()
		{
			return NBPanel.tabs.tabList[NBPanel.tabs.activeTab].brushes;
		},

		setBrushColor:function(inBrush, isFG)
		{
			if (!NBPanel.settings.values.useColor) return;

			var curElement = inBrush.tabEntry.button.childNodes[1].childNodes[0].childNodes[isFG?0:1] //Pick FG/BG childnode
			var tabEntry = inBrush.tabEntry;
			var id = inBrush.tabEntry.id
			


			JSONtoJSX("pickColor", {}, function(retVal)
			{
				if (retVal == null) return;
				curElement.style.backgroundColor ="rgb("+Math.floor(retVal.red)+","+Math.floor(retVal.green)+","+Math.floor(retVal.blue)+")"
				if (isFG)
				{
					tabEntry.data.colorFG = retVal;		
				}
				else //BG
				{
					tabEntry.data.colorBG = retVal;	
				}

				inBrush.saveFile()
				inBrush.tabEntry.button.childNodes[0].onclick();

			})
		},

		brush:function(inID)
		{
			var tabEntry = null;
			var tabIndex = null;
			var brushIndex = null;
			var element = null;	

			for (var i = 0; i < NBPanel.tabs.tabList.length; i++)
			{
				for (var j = 0; j < NBPanel.tabs.tabList[i].brushes.length; j++)
				{
					if (NBPanel.tabs.tabList[i].brushes[j].id == inID)
					{
						tabIndex = i;
						brushIndex = j;
					} 
				}
			}

			var retBrush =
			{
				id:inID,
				tabEntry:NBPanel.tabs.tabList[tabIndex].brushes[brushIndex],
				tabIndex:tabIndex,
				brushIndex:brushIndex,
				element:NBPanel.tabs.tabList[tabIndex].brushes[brushIndex].button,

				saveFile:function()
				{
					var pathDest = path.joinU(NBPanel.path.entries,  this.id, "Entry.json")
					fs.outputJsonSync(pathDest, this.tabEntry.data)			
				},

				setColorBG:function()
				{
					NBPanel.brushes.setBrushColor(this,false)
				},

				setColorFG:function()
				{
					NBPanel.brushes.setBrushColor(this,true)
				},

				moveToTab:function(inTabID)
				{
					var sourceTab = NBPanel.tabs.tabList[this.tabIndex]
					var destTab = NBPanel.tabs.getTabById(inTabID)

					destTab.brushGroup.insertAdjacentElement("beforeend",this.element)

					destTab.brushes.push(sourceTab.brushes[this.brushIndex])
					destTab.data.brushes.push(sourceTab.data.brushes[this.brushIndex])

					sourceTab.brushes.splice(this.brushIndex, 1)
					sourceTab.data.brushes.splice(this.brushIndex, 1)

					NBPanel.tabs.tab(sourceTab.data.id).writeFile()
					NBPanel.tabs.tab(destTab.data.id).writeFile()
				},

				copyToShared:function()
				{
					Modal_Loading.open("Processing...")
					NBPanel.sharedTab.appendBrush(this)

					setTimeout(function()
					{
						Modal_Loading.close();
					}, 250); 
				},

				remove:function()
				{
					var BPreset = "SB_Entry:" + this.id

					fs.remove( path.joinU ( NBPanel.path.entries, this.id )  )													//delete brush entry folder
					csInterface.evalScript("ToolPresets.removePresetByName('"+BPreset+"')");					//delete brush preset
					removeElement(this.element)																	//remove brush html element
					NBPanel.tabs.tabList[this.tabIndex].brushes.splice(this.brushIndex, 1)						//remove brush from tab list
					NBPanel.tabs.tabList[this.tabIndex].data.brushes.splice(this.brushIndex, 1)					//remove brush from tab brushes
					NBPanel.tabs.tabIndex(this.tabIndex).writeFile()											//save tab
					
				},

			}

			return retBrush
		},

		createBrushButtonShared:function(inPath, inID)
		{

			var pathSource = path.joinU(inPath,"Entry.json")
			var brushData = fs.readJsonSync(pathSource)

		    var btnGrp = document.createElement("div");
    		btnGrp.id = "Shared_brs_" + inID
		    btnGrp.draggable = "true"
			btnGrp.className = "BrushHolder"
			btnGrp.ondragstart = function(event){brushDrag(event)}
			btnGrp.ondragover =  function(event){brushDragOver(event)}
			btnGrp.ondragend = function(event){brushSharedDragEnd(event)}


			var btn = document.createElement("BUTTON");
			btnGrp.appendChild(btn);
			btn.className = "BrushButton"
			btn.value = inID
			btn.onclick = function(){eval(this.dataset.script)}
			btn.oncontextmenu = function(event){event.stopPropagation(); contextSharedBrush(this.value)}


			var stringFG = "JSON.stringify(NBPanel.sharedTab.brush(\"" + inID + "\").tabEntry.data.colorFG)"
			var stringBG ="JSON.stringify(NBPanel.sharedTab.brush(\"" + inID + "\").tabEntry.data.colorBG)"
			var pathABR = path.joinU(inPath, "Entry.abr") 
			btn.dataset.script = "setEntryPath('" + pathABR + "'," + stringFG + "," + stringBG + ")";

			var thumbShort = "url("+ encodeURI(path.joinU(inPath,"ThumbShort.png"))+"?" + new Date().getTime()  + ")"
			var thumbLong = "url("+ encodeURI(path.joinU(inPath, "ThumbLong.png"))+"?" + new Date().getTime()  + ")"
			btn.style.backgroundImage = thumbShort +"," + thumbLong





			//Text lable group
			var textLabel = document.createElement("div");
			btnGrp.appendChild(textLabel);
			textLabel.className = "textLabel"
		
			textLabel.ondblclick = function()
			{
				this.childNodes[1].disabled = ""
				this.childNodes[1].setAttribute("data-oldvalue", this.childNodes[1].value)
				this.childNodes[1].focus()
			}




				// Color buttons
				var colorsGroup = document.createElement("span")
				textLabel.appendChild(colorsGroup)
				colorsGroup.style.marginRight = "10px"
				var colorDefault = "#444444"

				var colorL = document.createElement("button")
				colorL.className = "ColorDotLeft"

				colorL.onclick = function()
				{
					NBPanel.brushes.setBrushColor(NBPanel.sharedTab.brush(inID),true)

				}

				if (brushData.colorFG == null)
				{colorL.style.backgroundColor = colorDefault}
				else
				{colorL.style.backgroundColor = "rgb("+ Math.floor(brushData.colorFG.red) + "," + Math.floor(brushData.colorFG.green) + "," + Math.floor(brushData.colorFG.blue) +")"}
				colorsGroup.appendChild(colorL)

				var colorR = document.createElement("button")
				colorR.className = "ColorDotRight"
				colorR.onclick = function()
				{
					NBPanel.brushes.setBrushColor(NBPanel.sharedTab.brush(inID),false)
				}
				if (brushData.colorBG == null)
				{colorR.style.backgroundColor = colorDefault}
				else
				{colorR.style.backgroundColor = "rgb("+ Math.floor(brushData.colorBG.red) + "," + Math.floor(brushData.colorBG.green) + "," + Math.floor(brushData.colorBG.blue) +")"}
				colorsGroup.appendChild(colorR)



				//Button Name text
				var btn_Edit = document.createElement("input");
				textLabel.appendChild(btn_Edit)
				btn_Edit.type = "text"
				btn_Edit.id = "btn_Edit_" + inID

				btn_Edit.spellcheck="false"
				btn_Edit.value = brushData.name
				btn_Edit.className = "editTab"
				btn_Edit.disabled = "disabled"

				btn_Edit.onkeydown = function(event)
				{
					switch(event.keyCode)
					{
						case 13: //Enter
							this.disabled = "disabled"
							this.dataset.oldvalue = this.value

							var curID = this.id.substring(9)
							var curBrush = NBPanel.sharedTab.brush(curID);
							curBrush.tabEntry.data.name = this.value
							curBrush.saveFile();
							NBPanel.sharedTab.saveFile();
							break;

						case 27: //Esc
							this.disabled = "disabled"
							this.value = this.dataset.oldvalue
							break;
					}
				}
				btn_Edit.onblur = function()
				{
					this.onkeydown({keyCode:27})
				}
	

	

	


			
			return btnGrp;
		},

		createBrushButton:function(inBrushID)
		{
			var brushDataPath = path.joinU (NBPanel.path.entries, inBrushID ,"Entry.json")
			var brushData =	fs.readJsonSync(brushDataPath)

	

			//Group for the whole brush
		    var btnGrp = document.createElement("div");
		    btnGrp.draggable = "true"
			btnGrp.className = "BrushHolder"
			btnGrp.ondragstart = function(event){brushDrag(event)}
			btnGrp.id = "brs_" + inBrushID
			btnGrp.ondragover =  function(event){brushDragOver(event)}
			btnGrp.ondragend = function(event){brushDragEnd(event)}


			var btn = document.createElement("BUTTON");
			btnGrp.appendChild(btn);
			btn.value = inBrushID
			btn.className = "BrushButton"

			var stringFG = "JSON.stringify(NBPanel.brushes.brush(\"" + inBrushID + "\").tabEntry.data.colorFG)"
			var stringBG ="JSON.stringify(NBPanel.brushes.brush(\"" + inBrushID + "\").tabEntry.data.colorBG)"
			var stringPath = path.joinU (NBPanel.path.entries, inBrushID, "Entry.abr")			
			btn.dataset.script = "setEntryPath('" + stringPath + "'," + stringFG + "," + stringBG + ");" +	"NBPanel.recentBrushes.add('" + stringPath + "')";

			btn.onclick = function(){eval(this.dataset.script)}
			btn.oncontextmenu = function(event){event.stopPropagation(); contextBrush(this.value)}

			var thumbShort = "url("+ encodeURI(path.joinU(NBPanel.path.entries, inBrushID, "ThumbShort.png"))+"?" + new Date().getTime()  + ")"
			var thumbLong = "url("+ encodeURI(path.joinU(NBPanel.path.entries, inBrushID, "ThumbLong.png"))+"?" + new Date().getTime()  + ")"
			btn.style.backgroundImage = thumbShort + "," + thumbLong;



			//Text lable group
			var textLabel = document.createElement("div");
			btnGrp.appendChild(textLabel);

			textLabel.className = "textLabel"
			textLabel.ondblclick = function()
			{
				this.childNodes[1].disabled = ""
				this.childNodes[1].setAttribute("data-oldvalue", this.childNodes[1].value)
				this.childNodes[1].focus()
			}

				// Color buttons
				var colorsGroup = document.createElement("span")
				textLabel.appendChild(colorsGroup)
				colorsGroup.style.marginRight = "10px"
				var colorDefault = "#444444"

				var colorL = document.createElement("button")
				colorL.className = "ColorDotLeft"
				colorL.onclick = function()
				{
					var curBrush = NBPanel.brushes.brush(inBrushID).setColorFG()
				}
				if (brushData.colorFG == null)
				{colorL.style.backgroundColor = colorDefault}
				else
				{colorL.style.backgroundColor = "rgb("+ Math.floor(brushData.colorFG.red) + "," + Math.floor(brushData.colorFG.green) + "," + Math.floor(brushData.colorFG.blue) +")"}
				colorsGroup.appendChild(colorL)

				var colorR = document.createElement("button")
				colorR.className = "ColorDotRight"
				colorR.style.backgroundColor = "rgb("+ Math.floor(Math.random() * 256) + "," + Math.floor(Math.random() * 256) + "," + Math.floor(Math.random() * 256) +")"
				colorR.onclick = function()
				{
					var curBrush = NBPanel.brushes.brush(inBrushID).setColorBG()
				}
				if (brushData.colorBG == null)
				{colorR.style.backgroundColor = colorDefault}
				else
				{colorR.style.backgroundColor = "rgb("+ Math.floor(brushData.colorBG.red) + "," + Math.floor(brushData.colorBG.green) + "," + Math.floor(brushData.colorBG.blue) +")"}
				colorsGroup.appendChild(colorR)


			//Button Name text
				var btn_Edit = document.createElement("input");
				textLabel.appendChild(btn_Edit)
				btn_Edit.type = "text"
				btn_Edit.spellcheck="false"
				btn_Edit.className = "editTab"
				btn_Edit.disabled = "disabled"

				btn_Edit.id = "btn_Edit_" + inBrushID
				btn_Edit.value = brushData.name

				btn_Edit.onkeydown = function(event)
				{
					switch(event.keyCode)
					{
						case 13: //Enter
							this.disabled = "disabled"
							this.dataset.oldvalue = this.value

							var curID = this.id.substring(9)
							var curBrush = NBPanel.brushes.brush(curID);
							curBrush.tabEntry.data.name = this.value
							curBrush.saveFile();
							break;

						case 27: //Esc
							this.disabled = "disabled"
							this.value = this.dataset.oldvalue
							break;
					}

				}
				btn_Edit.onblur = function()
				{
					this.onkeydown({keyCode:27})
				}

		
			return btnGrp;
		},

		updateLook:function()
		{
			var sliderValue = document.getElementById("sizeSlider").value
			var curTabs = NBPanel.tabs.tabList
			for (var i = 0; i < curTabs.length; i++)
			{
				for (var j = 0; j < curTabs[i].brushes.length; j++)
				{
					curTabs[i].brushes[j].update(sliderValue);
				}
			}

			for (var i = 0; i < NBPanel.sharedTab.brushList.length; i++)
			{
				NBPanel.sharedTab.brushList[i].update(sliderValue);
			}
		},

	}


	this.sharedTab=
	{
		brushList:[],
		tabButton:document.getElementById("btn_Shared"),
		tabBody:document.getElementById("sharedTabBrushGroup"),

		onFolderChange:function (event, filename)
		{
			NBPanel.sharedTab.refresh();
		},

		setPath:function()
		{
			var currentFile = window.cep.fs.showOpenDialogEx(false, true,"Share Location:", null,null, "Open Share Path").data;
			if (currentFile == null || currentFile == "") return;
			currentFile = currentFile[0];



			fs.unwatchFile(path.joinU(NBPanel.settings.values.shareLocation,"manifest.json"))
			NBPanel.settings.values.shareLocation = currentFile;
			NBPanel.settings.write();

			fs.watchFile(path.joinU(NBPanel.settings.values.shareLocation,"manifest.json"),{persistent:true, interval:1000}, NBPanel.sharedTab.onFolderChange);
			NBPanel.sharedTab.onFolderChange()
		},

		brush:function(inID)
		{
			var curIndex = null

			for (var i = 0; i < this.brushList.length; i++)
			{
				if (inID == this.brushList[i].id)
				{
					curIndex = i;
					break;
				}
			}

			var retBrush = 
			{
				id:inID,
				index:curIndex,
				brushIndex:curIndex,
				tabEntry:NBPanel.sharedTab.brushList[curIndex],
				element:NBPanel.sharedTab.brushList[curIndex].button,

				saveFile:function()
				{
					var pathDest = path.joinU (NBPanel.settings.values.shareLocation, "entries" ,this.id, "Entry.json")
					fs.outputJsonSync(pathDest, this.tabEntry.data)			
				},

				removeBrush:function()
				{
					removeElement(this.tabEntry.button)
					NBPanel.sharedTab.brushList.splice(this.index,1)
					NBPanel.sharedTab.saveFile();

					var pathDest = path.joinU(NBPanel.settings.values.shareLocation,"entries",this.id)
					fs.removeSync(pathDest)
				},

				copyToTab:function (inTab)
				{
					Modal_Loading.open("Processing...")

					var newEntryID = getEntryInc(NBPanel.path.entries)

					var pathDest = path.joinU(NBPanel.path.entries, newEntryID) 
					fs.mkdirSync(pathDest);

					var pathSource = path.joinU(NBPanel.settings.values.shareLocation, "entries", this.id)
					fs.copySync(pathSource, pathDest)


					NBPanel.tabs.tab(inTab).listTab.data.brushes.push(newEntryID)
					NBPanel.tabs.tab(inTab).writeFile()
					NBPanel.tabs.tab(inTab).appendBrush(newEntryID)
					NBPanel.brushes.brush(newEntryID).saveFile()

					setTimeout(function()
					{
						Modal_Loading.close();
					}, 250); 
				},
			}

			return retBrush

		},

		init:function()
		{
			//Set tabness
			this.tabButton.dataset.id = "SHARED"
			this.tabButton.onclick = function()
			{
				if (this.childNodes[0].disabled != "")
				{
					NBPanel.tabs.tab(this.dataset.id).setActive()
				}
			}
			this.tabButton.ondrop = function(event){tabSharedOnDrop(event)}

			this.loadEntries();

			var pathSource = path.joinU (NBPanel.settings.values.shareLocation, "manifest.json")
			fs.watchFile(pathSource, {persistent:true, interval:1000}, NBPanel.sharedTab.onFolderChange);
		},

		loadEntries:function()
		{
			try
			{
				var pathSource = path.joinU (NBPanel.settings.values.shareLocation, "manifest.json")
				var loadedBrushList = fs.readJsonSync(pathSource).brushes
			}
			catch(e)
			{
				return // No entries found
			}

			for (var i = 0; i < loadedBrushList.length; i++)
			{
				NBPanel.sharedTab.createBrush(loadedBrushList[i])
			}	

		},

		refresh:function()
		{
			while (NBPanel.sharedTab.brushList.length > 0)
			{
				var curBrush = NBPanel.sharedTab.brushList.pop()
				removeElement(curBrush.button)
			}
			this.loadEntries();

			NBPanel.brushes.updateLook()
		},

		createBrush:function(inID)
		{
			var pathSource = path.joinU (NBPanel.settings.values.shareLocation, "Entries", inID)
			var pathEntry = path.joinU(pathSource, "Entry.json")
			var brushData = fs.readJsonSync(pathEntry)	

			var newButton = NBPanel.brushes.createBrushButtonShared(pathSource, inID)
			this.tabBody.appendChild(newButton)

			var curBrushData = {id: inID, button:newButton, update:NBPanel.event.updateBrush, data:brushData}
			NBPanel.sharedTab.brushList.push(curBrushData)	
		},

		appendBrush:function(inBrush)
		{
			var pathDest = path.joinU(NBPanel.settings.values.shareLocation, "Entries")
			fs.ensureDirSync(pathDest);
			var pathSource = path.joinU (NBPanel.path.entries, inBrush.id)

			var newID =  getEntryInc(pathDest)
				
			fs.copySync(pathSource, path.joinU(pathDest,newID))

			NBPanel.sharedTab.createBrush(newID)

			this.saveFile();
			NBPanel.brushes.updateLook()
		},

		getList:function()
		{
			var curList = []

			for (var i = 0; i < NBPanel.sharedTab.brushList.length; i++)
			{
				curList.push(NBPanel.sharedTab.brushList[i].id)
			}
			return curList;

		},

		saveFile:function()
		{

			if (!fs.existsSync(NBPanel.settings.values.shareLocation + "/")) return;			

			data = {brushes:this.getList()}
		
			var pathDest = path.joinU(NBPanel.settings.values.shareLocation, "manifest.json")
			fs.outputJsonSync(pathDest, data);
		},
		
		setActive:function()
		{

			document.getElementById("btn_AddFromFile").disabled = "disabled"
			document.getElementById("btn_AddFromFile").childNodes[1].style.opacity = 0.1
			document.getElementById("btn_AddTool").disabled = "disabled"
			document.getElementById("btn_AddTool").childNodes[1].style.opacity = 0.1


			NBPanel.tabs.activeTab = "SHARED"

			for(var i = 0; i < NBPanel.tabs.tabList.length; i++)
			{
					NBPanel.tabs.tabList[i].brushGroup.style.display = "none"
					NBPanel.tabs.tabList[i].button.className = "TabButton"					
			}

			NBPanel.sharedTab.tabBody.display = "block"
			NBPanel.sharedTab.tabButton.className = "TabButton_Selected TabShared"	

			NBPanel.tabs.writeTabListFile();
			NBPanel.sharedTab.tabButton.focus();
		},
	
	
	}



	this.tabs=
	{				
		tabList:[],
		tabListFile: "TabList.json",
		activeTab:0,

		init:function()
		{
	
			this.readTabListFile();
			this.tabCurrent().setActive()
		},


		readTabListFile:function()
		{
			try
			{

				var pathSource = path.joinU( NBPanel.path.data, this.tabListFile)
				var tabData = fs.readJsonSync(pathSource)


				this.activeTab = tabData.active;
				
				for(var i = 0; i < tabData.tabs.length; i++)
				{
					var pathSource = path.joinU (NBPanel.path.tabs, tabData.tabs[i])
					var curTabData = fs.readJsonSync(pathSource)
					this.tabList.push({data:curTabData, brushes:[]})
				}

				for(var i = 0; i < this.tabList.length; i++)
				{
					
					this.appendTabElement(this.tabList[i])
					
					for (var j = 0; j < this.tabList[i].data.brushes.length; j++)
					{
						this.tabIndex(i).appendBrush(this.tabList[i].data.brushes[j]);
					}

				}
			}
			catch(e)
			{
				this.tabList = []
			}

			if (this.tabList.length == 0) {this.appendTab("default", false)}

		},

		getTabById:function(inID)
		{
			for(var i = 0; i < this.tabList.length; i++)
			{
				if (this.tabList[i].data.id == inID) {return this.tabList[i];}
			}
			return null;
		},

		getIndexById:function(inID)
		{
			for(var i = 0; i < this.tabList.length; i++)
			{
				if (this.tabList[i].data.id == inID) {return i;}
			}
			return -1;
		},

		appendTabElement:function(inTab)
		{
			var inName = inTab.data.name

		//	Create Tab Button
			var btn_Edit = document.createElement("input");
			btn_Edit.type = "text"
			btn_Edit.value = inName
			btn_Edit.className = "editTab"
			btn_Edit.id = "btn_Edit_" + inTab.data.id
			btn_Edit.disabled = "disabled"


			btn_Edit.onkeydown = tabOnKeydown;
			btn_Edit.onblur = tabOnBlur;

		    $(btn_Edit).attr('size', $(btn_Edit).val().length);


			var btn = document.createElement("BUTTON");
			btn.appendChild(btn_Edit);

			btn.className = "TabButton"
			btn.draggable = "true"
			btn.ondrop = function(event){tabOnDrop(event)}
			btn.ondragstart = function(event){tabDrag(event)}
			btn.ondragover =  function(event){tabDragOver(event)}
			btn.ondragend = function(event){tabDragEnd(event)}

			btn.id = "TabButton_"+ inTab.data.id
			btn.value = inName;
			btn.setAttribute("data-id", inTab.data.id)

			btn.onclick = function()
			{
				if (this.childNodes[0].disabled != "")
				{
					NBPanel.tabs.tab(this.dataset.id).setActive()
				}

			}

			btn.oncontextmenu = function(event){event.stopPropagation(); contextTab(this.dataset.id)}

			btn.ondblclick = tabStartEdit;

			document.getElementById("TopBar").appendChild(btn);


		//Create Tab Body
		    var brushGroup = document.createElement("div");
			brushGroup.id = inName
			brushGroup.className = "scroll"
			document.getElementById("ContainerBar").appendChild(brushGroup)


			inTab.brushGroup = brushGroup;
			inTab.button = btn;
			return {group:brushGroup,button:btn} 

		},

		writeTabListFile:function()
		{
			var tabBuffer = []

			var tabData = {active: this.activeTab, tabs:[]}

			for (var i = 0; i < this.tabList.length; i++)
			{
				tabData.tabs.push(this.tabList[i].data.id)
			}	

			var pathDest = path.joinU(NBPanel.path.data, this.tabListFile)
			fs.outputJsonSync(pathDest, tabData)
		},

		appendTab:function(inName, inStartEdit)
		{
			inStartEdit = (inStartEdit == undefined) ? true : inStartEdit;

			var newTab = getEntryInc(NBPanel.path.tabs)

			tabData = {id:newTab ,name:inName, brushes:[]}

			var pathDest = path.joinU(NBPanel.path.tabs, newTab)
			fs.outputJsonSync(pathDest, tabData)


			var curTab = {data:tabData, brushes:[]}
			this.tabList.push(curTab)
			this.writeTabListFile();

			tabElement = this.appendTabElement(this.tabList[this.tabList.length-1]);
			this.tab(tabData.id).setActive()
			
			if (inStartEdit)
			{ this.tab(tabData.id).listTab.button.ondblclick();}

			NBPanel.event.resizeDoc()
		},

		tabIndex:function(inIndex
)		{
						//alert(inIndex)
			if (inIndex == null) return null;

			var retTab = 
			{
				index: inIndex,
				id: NBPanel.tabs.tabList[inIndex].data.id,
				name: NBPanel.tabs.tabList[inIndex].data.name,
				listTab:NBPanel.tabs.tabList[inIndex],
				element:"",

				//Adds brush button element to tab element
				appendBrush:function(inBrushID)
				{
					var newButton = NBPanel.brushes.createBrushButton(inBrushID)
					
					var pathSource = path.joinU(NBPanel.path.entries,inBrushID,"Entry.json")
					var brushData = fs.readJsonSync(pathSource)			
					this.listTab.brushes.push({data:brushData, id:inBrushID, button:newButton, update:NBPanel.event.updateBrush})

					this.listTab.brushGroup.appendChild(newButton)

					var sliderValue = document.getElementById("sizeSlider").value
					this.listTab.brushes[this.listTab.brushes.length-1].update(sliderValue)
				},

				getBrushIDs:function()
				{
					var IDList = []
					for (var i = 0; i < this.listTab.brushes.length; i++)
					{IDList.push(this.listTab.brushes[i].id)}

					return IDList
				},

				writeFile:function()
				{
					var pathDest = path.joinU(NBPanel.path.tabs, this.id)
					fs.outputJsonSync(pathDest , this.listTab.data)
				},

				rename:function(inName)
				{
					this.listTab.data.name = inName;
					NBPanel.tabs.writeTabListFile();
					this.writeFile()	
				},

				setActive:function()
				{
					document.getElementById("btn_AddFromFile").disabled = ""
					document.getElementById("btn_AddFromFile").childNodes[1].style.opacity = 0.5
					document.getElementById("btn_AddTool").disabled = ""
					document.getElementById("btn_AddTool").childNodes[1].style.opacity = 0.5

					NBPanel.tabs.activeTab = this.index
					NBPanel.sharedTab.tabButton.className = "TabButton TabShared"	

					for(var i = 0; i < NBPanel.tabs.tabList.length; i++)
					{

						if (i == NBPanel.tabs.activeTab)
						{

							NBPanel.tabs.tabList[i].brushGroup.style.display = "block"
							NBPanel.tabs.tabList[i].button.className = "TabButton_Selected"	
						}
						else
						{
							NBPanel.tabs.tabList[i].brushGroup.style.display = "none"
							NBPanel.tabs.tabList[i].button.className = "TabButton"					
						}
					}

					NBPanel.tabs.writeTabListFile();
					this.listTab.button.focus();
				},

				remove:function()
				{	
					var currentObj = this;

					if (this.listTab.brushes.length == 0)
					{
						removeCurTab(this);
						return;
					}

					var command = "confirm('Warning!\\n You are about to remove this tab\\n and all the brushes inside it!', true, 'Warning: Remove Tab')"

					csInterface.evalScript(command, function(retVal)
					{
						if (retVal == "false")
							return;

						while (currentObj.listTab.brushes.length > 0)
						{
							NBPanel.brushes.brush(currentObj.listTab.brushes[0].id).remove();
						}

						removeCurTab(currentObj);		
					})

					return;

					function removeCurTab(currentObj)
					{

						removeElement (currentObj.listTab.brushGroup)
						removeElement (currentObj.listTab.button)

						try
						{
							fs.removeSync(path.joinU(NBPanel.path.tabs, currentObj.id))	
						}
						catch(e){alert(e)}
						
						NBPanel.tabs.tabList.splice(currentObj.index, 1)
						NBPanel.tabs.tabIndex((currentObj.index-1)>-1 ? currentObj.index-1 : 0).setActive()
						NBPanel.tabs.writeTabListFile()
						NBPanel.event.resizeDoc()	
					}
				},

			}

			return retTab;
		},

		tabCurrent:function()
		{
			if (this.activeTab == "SHARED") return NBPanel.sharedTab
			return this.tabIndex(this.activeTab)
		},

		tab:function(inID)
		{

			if (inID == "SHARED") return NBPanel.sharedTab
			var curIndex = null;

			for(var i = 0; i < this.tabList.length; i++)
			{
				if (this.tabList[i].data.id == inID) {curIndex = i; break;}
			}
			
			return this.tabIndex (curIndex)
		},

	}

	this.settings =
	{
		file: "settings.json",

		values:
		{
			useColor: false,
			showText: true,
			showShortThumb: true,
			showLongThumb: true,
			scaleSlider: 64,
			activeBrushGroup:"",
			persistent: true,
			shareLocation:"",

			showTools:true,
			showRecent:true,
			showSearch:true,
			showShared:true,
		},

		showTools:function(inVal)
		{
			this.values.showTools = inVal;
			var ToolBar = document.getElementById("ToolBar")
			ToolBar.style.display = inVal?"block":"none";
		},

		showRecent:function(inVal)
		{
			this.values.showRecent = inVal;
			var RecentBar = document.getElementById("RecentBar")
			RecentBar.style.display = inVal?"block":"none";
		},

		showSearch:function(inVal)
		{
			this.values.showSearch = inVal;
			var SearchBar = document.getElementById("SearchBar")
			SearchBar.style.display = inVal?"block":"none";
		},

		showShared:function(inVal)
		{
			this.values.showShared = inVal;
		},

		apply: function()
		{
			csInterface.updatePanelMenuItem("Show Brush Thumbnail", true, this.values.showShortThumb);
			csInterface.updatePanelMenuItem("Show Stroke Thumbnail", true, this.values.showLongThumb);
			csInterface.updatePanelMenuItem("Show Brush Name", true, this.values.showText);
			this.setPersistent();
			NBPanel.brushes.updateLook()

		},

		save:function()
		{
			this.write();
		},

		write: function ()
		{
			var pathOut = path.joinU(NBPanel.path.data, NBPanel.settings.file)
			fs.outputJsonSync(pathOut, this.values)			
		},

		read: function()
		{
			var pathIn = path.joinU(NBPanel.path.data, NBPanel.settings.file)

			if (!fs.existsSync(pathIn)) return;
			var inValues = fs.readJsonSync(pathIn)

			this.values.scaleSlider = inValues.scaleSlider;
			this.values.persistent = inValues.persistent;
			this.values.shareLocation = inValues.shareLocation;


			this.setThumbShort(inValues.showShortThumb)
			this.setThumbLong(inValues.showLongThumb)
			this.setTxt(inValues.showText)
			this.setColor(inValues.useColor)


			if(inValues.showTools != undefined) this.showTools(inValues.showTools)
			if(inValues.showRecent != undefined) this.showRecent(inValues.showRecent)
			if(inValues.showSearch != undefined) this.showSearch(inValues.showSearch)
			if(inValues.showShared != undefined) this.showShared(inValues.showShared)


			this.values.activeBrushGroup = inValues.activeBrushGroup;
			document.getElementById("sizeSlider").value = this.values.scaleSlider
		},

		setPersistent: function()
		{		
			csInterface.updatePanelMenuItem("Persistent Panel", true, NBPanel.settings.values.persistent);
			if (this.values.persistent)
			{
				event = new CSEvent("com.adobe.PhotoshopPersistent", "APPLICATION");
			}
	        else
			{
	            event = new CSEvent("com.adobe.PhotoshopUnPersistent", "APPLICATION");
	        }
            event.extensionId = csInterface.getExtensionID();
            csInterface.dispatchEvent(event);
		},


		setThumbLong:function(inVal)
		{
			NBPanel.settings.values.showLongThumb = inVal;
			NBPanel.brushes.updateLook()
			NBPanel.settings.write()

			document.getElementById("toggleLongThumb").childNodes[1].src = inVal ? 'images/buttons/Button_LongThumb.png' : 'images/buttons/Button_LongThumb_off.png';
		},

		setThumbShort:function(inVal)
		{
			NBPanel.settings.values.showShortThumb = inVal;
			NBPanel.brushes.updateLook()
			NBPanel.settings.write()

			document.getElementById("toggleShortThumb").childNodes[1].src = inVal ? 'images/buttons/Button_ShortThumb.png' : 'images/buttons/Button_ShortThumb_off.png';
		},

		setColor:function(inVal)
		{
			if (inVal == undefined) inVal = true;
			NBPanel.settings.values.useColor = inVal;
			document.getElementById("toggleColor").childNodes[1].src = inVal ? 'images/buttons/Button_ColorChange.png' : 'images/buttons/Button_ColorChange_off.png';
			NBPanel.brushes.updateLook()

			NBPanel.settings.write()
		},

		setTxt:function(inVal)
		{
			NBPanel.settings.values.showText = inVal;
			NBPanel.brushes.updateLook()
			NBPanel.settings.write()

			document.getElementById("toggleTxt").childNodes[1].src = inVal ? 'images/buttons/Button_Txt.png' : 'images/buttons/Button_Txt_off.png';
		},

	}


	this.flyoutMenu = 
	{
		XML: 
		'<Menu> \
			<MenuItem Id="refreshMenuItem" Label="Refresh" Enabled="true" Checked="false"/> \
            <MenuItem Label="---" /> \
            <MenuItem Id="persistentMenu" Label="Persistent Panel" Enabled="true" Checked="true"/> \
            <MenuItem Id="openMenu" Label="Open Folder" Enabled="true" Checked="false"/> \
            <MenuItem Id="aboutMenu" Label="About" Enabled="true" Checked="false"/> \
        </Menu>',

        cacheLabel:"",

        handler: function(event)         // Flyout Menu Click Callback
		{
		    // the event's "data" attribute is an object, which contains "menuId" and "menuName"
		    switch (event.data.menuId)
		    {
    			case "aboutMenu":

					Modal_About.open();
    				break;

    			case "openMenu":
    				require('child_process').exec('start "" "'+path.normalize(NBPanel.path.data)+'"');
    				break;
		    			    	
				case "persistentMenu":
    				NBPanel.settings.values.persistent = !NBPanel.settings.values.persistent;
					NBPanel.settings.setPersistent()
	    			NBPanel.settings.write()	
	    			break;			

		        case "refreshMenuItem":
		            history.go(0);
		            break;

		        default:
		    }
		},


        populate: function()
        {
        	// Uses the XML string to build the menu
	    	csInterface.setPanelFlyoutMenu(this.XML);
	   		// Listen for the Flyout menu clicks
   			csInterface.addEventListener("com.adobe.csxs.events.flyoutMenuClicked", this.handler);
        },

	}

	this.initialize = function()
	{
		fs.ensureDirSync(NBPanel.path.data)
		fs.ensureDirSync(NBPanel.path.tabs)
		fs.ensureDirSync(NBPanel.path.entries)
		fs.ensureDirSync(NBPanel.path.temp)

		this.flyoutMenu.populate()
		this.settings.read()
		this.settings.apply();

		NBPanel.sharedTab.init();
		NBPanel.tabs.init();
		NBPanel.search.init();

		NBPanel.brushes.updateLook()
		NBPanel.event.resizeDoc();
	}
}

////////////////////////////////////////////////////////// Brush Stuff




/////////////////////////////////////////////////////////////////////////////GENERAL


























/***********************HTML***************************************************************/


function contextDefault()
{
 	csInterface.setContextMenuByJSON(JSON.stringify(null), function(res){})
}

function contextTab(inTabName)
{
	var contextJSON =
	{
		menu:
		[
			{
				id: "menuItemRemove",
				label: "Remove Tab",
				enabled: true,
				checkable: false,
				checked: false,
				icon: "./images/x.png"
			},
			{
				id: "menuItemExportTab",
				label: "Export Tab",
				enabled: true,
				checkable: false,
				checked: false,
			},
		]
	};
 
 	csInterface.setContextMenuByJSON(JSON.stringify(contextJSON), function(res) {
 	switch(res)
 	{
		case "menuItemExportTab":
			NBPanel.export.tab(inTabName)
			break;
 		case "menuItemRemove":
			NBPanel.tabs.tab(inTabName).remove()
 			break;
 	}
});
}

function contextSharedTab()
{
	var contextJSON =
	{
		menu:
		[
			{
				id: "menuSetPath",
				label: "Set share location",
				enabled: true,
				checkable: false,
				checked: false,
			},
			{
				id: "menuOpenPath",
				label: "Open share folder",
				enabled: true,
				checkable: false,
				checked: false,
			},
		]
	};
 
 	csInterface.setContextMenuByJSON(JSON.stringify(contextJSON), function(res) {
 	switch(res)
 	{
		case "menuSetPath":
			NBPanel.sharedTab.setPath();
			break;
		case "menuOpenPath":
			require('child_process').exec('start "" "'+path.normalize(NBPanel.settings.values.shareLocation)+'"');
			break;
 	}
});
}

function contextBrush(inBrushName)
{

	var tabsContext = []
	var tabs = NBPanel.tabs.tabList

	for (var i = 0; i < tabs.length; i++)
	{
		tabsContext.push ({id:"TAB_" + tabs[i].data.id, label:tabs[i].data.name})
	}
	var curBrush = NBPanel.brushes.brush(inBrushName)

	var contextJSON =
	{
		menu:
		[
			{
				id: "menuItemRemove",
				label: "Remove Brush",
				enabled: true,
				checkable: false,
				checked: false,
				icon: "./images/x.png"
			}, 

			{
				id: "menuItemExport",
				label: "Export Brush",
				enabled: true,
				checkable: false,
				checked: false,
			}, 

			{
				id: "menuMoveToTab",
				label: "Move To",
				menu:tabsContext
	
			},

			{
				id: "menuCopyToShared",
				label: "Copy to Shared",
				enabled: true,
				checkable: false,
				checked: false,
			}, 

		]
	};

 	csInterface.setContextMenuByJSON(JSON.stringify(contextJSON), function(res) {
 	switch(res)
 	{
 		case "menuItemRemove":
			curBrush.remove();
 			break;

		case "menuItemExport":
			NBPanel.export.brush(inBrushName)
			break;

		case "menuCopyToShared":
			NBPanel.brushes.brush(inBrushName).copyToShared()

		default:
			if (res.substring(0,4) == "TAB_")
			{
				NBPanel.brushes.brush(inBrushName).moveToTab(res.substring(4))
			}

			break;
 	}
});
}


function contextSharedBrush(inBrushName)
{
	var tabsContext = []
	var tabs = NBPanel.tabs.tabList

	for (var i = 0; i < tabs.length; i++)
	{
		tabsContext.push ({id:"TAB_" + tabs[i].data.id, label:tabs[i].data.name})
	}

	var curBrush = NBPanel.brushes.brush(inBrushName)

	var contextJSON =
	{
		menu:
		[
			{
				id: "menuItemRemove",
				label: "Remove Brush",
				enabled: true,
				checkable: false,
				checked: false,
				icon: "./images/x.png"
			}, 
			{
				id: "menuCopyToTab",
				label: "Copy To",
				menu:tabsContext
	
			},
		]
	};

 	csInterface.setContextMenuByJSON(JSON.stringify(contextJSON), function(res) {
 	switch(res)
 	{
 		case "menuItemRemove":
			var command = "confirm('Warning!\\n You are about to remove this brush.\\n this will remove it for everyone using to this share', true, 'Warning: Remove Shared Brush')"
			csInterface.evalScript(command, function(retVal)
			{
				if (retVal == "false") return;
				NBPanel.sharedTab.brush(inBrushName).removeBrush()
			})
 			break;

		case "menuItemTestBrush":
			alert(inBrushName)
			break;

		default:
			if (res.substring(0,4) == "TAB_")
			{
				NBPanel.sharedTab.brush(inBrushName).copyToTab(res.substring(4))
			}

			break;
 	}
});
}



function tabOnKeydown(event)
{
	switch(event.keyCode)
	{
		case 13: //Enter
			NBPanel.tabs.tab(this.parentElement.dataset.id).rename(this.value)
			this.disabled = "disabled"
			this.dataset.oldvalue = this.value
			break;

		case 27: //Esc
			this.disabled = "disabled"
			this.value = this.dataset.oldvalue
			break;
	}
		$(this).attr('size', $(this).val().length);
}

function tabOnBlur()
{
	this.disabled = "disabled"
	this.value = this.dataset.oldvalue
    $(this).attr('size', $(this).val().length);	
}

function brushDragOver(event)
{
	var curElement = document.getElementById(event.dataTransfer.getData("text/plain"))
	var target = event.target.parentElement

	while(true)
	{
		if (target.parentElement == null) return;
		if (target == curElement) return;
		if (target.id.substring(0,4) == "brs_")
		{
			var movingBrush = NBPanel.brushes.brush(curElement.id.substring(4))
			var staticBrush = NBPanel.brushes.brush(target.id.substring(4))
			arrangeBrush(movingBrush,staticBrush)
		}

		if (target.id.substring(0,11) == "Shared_brs_")
		{

			var movingBrush = NBPanel.sharedTab.brush(curElement.id.substring(11))
			var staticBrush = NBPanel.sharedTab.brush(target.id.substring(11))
			arrangeSharedBrush(movingBrush,staticBrush)
		}		

		target = target.parentElement;
	}
}

function arrangeSharedBrush (movingBrush, staticBrush)
{
	if (staticBrush.brushIndex < movingBrush.brushIndex )
	{staticBrush.element.insertAdjacentElement("beforebegin", movingBrush.element)}
	else
	{staticBrush.element.insertAdjacentElement("afterend", movingBrush.element)	}

	//Move brush entries	
	var curTab = NBPanel.sharedTab.brushList
	curTab.splice(movingBrush.brushIndex, 1)
	curTab.splice(staticBrush.brushIndex, 0, movingBrush.tabEntry)	

	//Move brush IDs in tab's list 
	var curBrush = curTab[movingBrush.brushIndex]	
	curTab.data.brushes.splice(movingBrush.brushIndex, 1)
	curTab.data.brushes.splice(staticBrush.brushIndex, 0, curBrush)
}


function arrangeBrush (movingBrush, staticBrush)
{

	if (staticBrush.brushIndex < movingBrush.brushIndex )
	{staticBrush.element.insertAdjacentElement("beforebegin", movingBrush.element)}
	else
	{staticBrush.element.insertAdjacentElement("afterend", movingBrush.element)	}

	//Move brush entries	
	var curTab = NBPanel.tabs.tabList[staticBrush.tabIndex]
	curTab.brushes.splice(movingBrush.brushIndex, 1)
	curTab.brushes.splice(staticBrush.brushIndex, 0, movingBrush.tabEntry)	

	//Move brush IDs in tab's list 
	var curBrush = curTab.data.brushes[movingBrush.brushIndex]	
	curTab.data.brushes.splice(movingBrush.brushIndex, 1)
	curTab.data.brushes.splice(staticBrush.brushIndex, 0, curBrush)
}

function brushDragEnd(ev) 
{
	NBPanel.tabs.tabCurrent().writeFile()
    ev.target.childNodes[0].className = "BrushButton"
    ev.target.childNodes[0].focus()
}

function brushSharedDragEnd(ev) 
{
	NBPanel.sharedTab.saveFile()
    ev.target.childNodes[0].className = "BrushButton"
    ev.target.childNodes[0].focus()
}

function brushDrag(ev) 
{
	ev.target.childNodes[0].onclick()
    ev.dataTransfer.setData("text", ev.target.id);
	ev.target.childNodes[0].className = "BrushButton_Selected"
    var dragImage = document.createElement("img")
    ev.dataTransfer.setDragImage(dragImage, 0, 0)
}

function tabDragOver(event)
{
	var source = document.getElementById(event.dataTransfer.getData("text/plain"))
	var target = event.target

	while(true)
	{
			if (target == source ) return;
			if (target == null) return;
			if (target.id.substring(0,10) == "TabButton_") break;
			target = target.parentElement;
	}

	if (source.id.substring(0,10) == "TabButton_")	{arrangeTab(source,target); return;}

}

function tabSharedOnDrop(event)
{
	var source = document.getElementById(event.dataTransfer.getData("text/plain"))
	var target = event.target

	if (source.id.substring(0,4) == "brs_")
	{
		NBPanel.brushes.brush(source.id.substring(4)).copyToShared()
	}
}

function tabOnDrop(event)
{
	var source = document.getElementById(event.dataTransfer.getData("text/plain"))
	var target = event.target
	
	while(true)
	{
			if (source == target) return;
			if (target == null) return;
			if (target.id.substring(0,10) == "TabButton_") break;
			target = target.parentElement;
	}

	if (source.id.substring(0,4) == "brs_" && target.id.substring(0,10) == "TabButton_")
	{

		NBPanel.brushes.brush(source.id.substring(4)).moveToTab(target.dataset.id)	
		return;
	}
	if (source.id.substring(0,11) == "Shared_brs_")
	{

		Modal_Loading.open("Processing...")

		NBPanel.sharedTab.brush(source.id.substring(11)).copyToTab(target.dataset.id)
		setTimeout(function()
		{
			Modal_Loading.close();
		}, 250); 
	}	

}

function arrangeTab (movingTab, staticTab)
{
	var movingIndex = NBPanel.tabs.getIndexById(movingTab.dataset.id)
	var staticIndex = NBPanel.tabs.getIndexById(staticTab.dataset.id)

	if (staticIndex < movingIndex )
	{staticTab.insertAdjacentElement("beforebegin", movingTab)}
	else
	{staticTab.insertAdjacentElement("afterend", movingTab)	}

	var curTab = NBPanel.tabs.tabList[movingIndex]
	NBPanel.tabs.tabList.splice(movingIndex,1) 
	NBPanel.tabs.tabList.splice(staticIndex,0,curTab)
}

function tabDragEnd(event)
{
	NBPanel.tabs.writeTabListFile();
}


function tabDrag(ev) 
{
	document.getElementById(ev.target.id).onclick()
    ev.dataTransfer.setData("text", ev.target.id);
    var dragImage = document.createElement("img")
	ev.target.style.cursor = 'grabbing'
	ev.dataTransfer.setDragImage(dragImage, 0, 0)
}




function tabStartEdit()
{
	this.childNodes[0].disabled = ""
	this.childNodes[0].setAttribute("data-oldvalue", this.childNodes[0].value)
	this.childNodes[0].focus()
	this.childNodes[0].select()
}

function keydownSelectAll(e)
{
    if (e.keyCode == 65 && e.ctrlKey) {document.getElementById("searchText").select()}
}

/***********************HTML_END***********************************************************/




/***********************PHOTOSHOP**********************************************************/

function setEntryPath(inPath,inColorFG,inColorBG)
{
	if (!NBPanel.settings.values.useColor)
	{
		inColorFG = undefined;
		inColorBG = undefined;
	}
	csInterface.evalScript("setEntryPath('" + inPath +"','" + inColorFG + "','" + inColorBG + "');");	

}

/***********************PHOTOSHOP_END******************************************************/




/***********************GENERAL************************************************************/

function getEntryInc(inPath)
{
	var fileList = fs.readdirSync(inPath).sort()

	var newTab;

	if (fileList.length == 0)
	{
		newTab = padZeroes(0,8)
	}
	else
	{
		newTab = padZeroes (parseInt(fileList[fileList.length-1]) + 1 , 8)  
	}

	return newTab;
}

function padZeroes(num, size)
{
	var s = num+"";
	while (s.length < size) s = "0" + s;
	return s;
}
/***********************GENERAL_END********************************************************/
</script>